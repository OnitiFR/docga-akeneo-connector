'use strict';'use-strict';var _extends=Object.assign||function(a){for(var c,b=1;b<arguments.length;b++)for(var j in c=arguments[b],c)Object.prototype.hasOwnProperty.call(c,j)&&(a[j]=c[j]);return a},_createClass=function(){function a(b,c){for(var l,j=0;j<c.length;j++)l=c[j],l.enumerable=l.enumerable||!1,l.configurable=!0,'value'in l&&(l.writable=!0),Object.defineProperty(b,l.key,l)}return function(b,c,j){return c&&a(b.prototype,c),j&&a(b,j),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var DocGaAPI=function(){function a(b,c,j){_classCallCheck(this,a),this.serveur_url=b.replace(/[\/]+$/g,''),this.api_key=c,this.api_secret=j,this.route_directories='api/categories',this.route_documents='api/list',this.directories=null,this.documents=null,this.documents_selected=[],this.current_slug=null,this.directory_ariane=[]}return _createClass(a,[{key:'initialise',value:function initialise(){var b=this;this.modal=$('#modal_docga'),this.closebtn=$('#modal_docga .docga_close'),this.modal.off('click'),this.closebtn.off('click'),$('#docga_valid_selection').off('click'),this.closebtn.click(this.handlerClose.bind(this)),this.modal.click(function(c){'modal_docga'===c.target.id&&b.handlerClose()}),$('#docga_valid_selection').click(function(){b.callbackUser(b.documents_selected.map(function(j){return _extends({},b.documents[j],{slug:j})})),b.handlerClose()})}},{key:'handlerClose',value:function handlerClose(){this.modal.fadeOut()}},{key:'cleanModal',value:function cleanModal(){this.directories=null,this.documents=null,this.documents_selected=[],$('.directoriesLine').remove(),$('.docga_document').remove(),this.addOrRemoveLoader('documents',!0),this.addOrRemoveLoader('directories',!0)}},{key:'addOrRemoveLoader',value:function addOrRemoveLoader(b,c){var j=null;'directories'===b?j='.docga_directories-tree':'documents'==b&&(j='.docga_documents'),j&&(c&&0===$(j+' .docga_loader').length?$(j).append('<div class=\'docga_loader\'></div>'):$(j+' .docga_loader').remove())}},{key:'open',value:function open(){this.cleanModal(),this.getDirectories(),this.insertModal(),this.initialise(),this.modal.fadeIn()}},{key:'getDocuments',value:function getDocuments(){var c=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'home';this.callUrl(this.route_documents,{dirlist:b},function(j){c.documents=j.data,c.renderDocuments()})}},{key:'renderDocuments',value:function renderDocuments(){if(this.documents){for(var b in this.addOrRemoveLoader('documents',!1),this.documents)$('.docga_documents').append(this.getDocumentDiv(this.documents[b],b));var c=this;$('.docga_document').click(function(j){j.preventDefault();var o=$(this).closest('.docga_document');o.toggleClass('selected');var l=c.documents_selected.indexOf(j.target.dataset.slug);-1===l?c.documents_selected.push(j.target.dataset.slug):c.documents_selected.splice(l,1)})}}},{key:'getDocumentDiv',value:function getDocumentDiv(b,c){return'<div class=\'docga_document\' data-slug=\''+c+'\'><div class=\'docga_thumb\' data-slug=\''+c+'\'><img src=\''+b.thumbnail+'\' alt=\'thumbnail\' data-slug=\''+c+'\'></div><div class=\'docga_title\' data-slug=\''+c+'\'>'+b.title+'</div></div>'}},{key:'getDirectories',value:function getDirectories(){var c=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'home';$('.docga_ariane-directory').remove(),this.callUrl(this.route_directories,{deep:'home'===b?0:1,slug:b},function(j){c.updateAriane(b,j),c.directories=j,c.current_slug=b,c.renderDirectories()}),this.getDocuments(b)}},{key:'updateAriane',value:function updateAriane(b,c){var j=this.directory_ariane.map(function(l){return l.slug}).indexOf(b);-1===j?this.directory_ariane.push({slug:b,title:'home'===b?'Accueil':c[b].title}):this.directory_ariane=this.directory_ariane.slice(0,j+1)}},{key:'renderAriane',value:function renderAriane(){var b=this;$('.docga_ariane-directory').remove(),this.directory_ariane.forEach(function(c,j){$('.docga_ariane_directories').append('<span class=\'docga_ariane-directory\' data-slug=\''+c.slug+'\'>'+c.title+(b.directory_ariane.length-1===j?'':' / ')+'</span>')}),$('.docga_ariane-directory').click(this.onClickDirectory.bind(this))}},{key:'renderDirectories',value:function renderDirectories(){if(this.directories){this.renderAriane(),this.addOrRemoveLoader('directories',!1);var j='home'===this.current_slug;for(var b in j||$('.docga_directories-tree').append(this.getDirectoryDiv({title:'...'},this.directory_ariane[this.directory_ariane.length-2].slug)),this.directories)if(j)$('.docga_directories-tree').append(this.getDirectoryDiv(this.directories[b],b));else for(var c in this.directories[b].children)$('.docga_directories-tree').append(this.getDirectoryDiv(this.directories[b].children[c],c));$('.directoriesLine').click(this.onClickDirectory.bind(this))}}},{key:'onClickDirectory',value:function onClickDirectory(b){b.preventDefault(),this.cleanModal(),this.getDirectories(b.target.dataset.slug)}},{key:'getDirectoryDiv',value:function getDirectoryDiv(b,c){return'<div class=\'directoriesLine\' data-slug=\''+c+'\'><a title=\''+b.title+'\' href=\'\'#\' data-slug=\''+c+'\'><span class=\'docga_chevron right\' data-slug=\''+c+'\'></span>'+b.title+'</a></div>'}},{key:'callUrl',value:function callUrl(b,c,j){$.getJSON(this.buildUrl(b,c)).done(function(l){j(l)}).fail(function(l){var o='Une erreur est survenue lors de l\'\xE9change avec l\'api';l.responseJSON&&(o=l.responseJSON.error),alert(o)})}},{key:'buildUrl',value:function buildUrl(b,c){c||(c={}),c.api_key=this.api_key,c=Object.keys(c).sort().reduce(function(l,o){return l[o]=c[o],l},{});var j=this.api_secret;return Object.keys(c).forEach(function(l){Array.isArray(c[l])&&(j+='Array'),'api_sig'!==l&&'source'!==l&&(j+=l+c[l])}),j=md5(j),c.api_sig=j,this.serveur_url+'/'+b+'?'+this.encodeQueryData(c)}},{key:'encodeQueryData',value:function encodeQueryData(b){var c=[];for(var j in b)c.push(encodeURIComponent(j)+'='+encodeURIComponent(b[j]));return c.join('&')}},{key:'setCallbackFilesSelected',value:function setCallbackFilesSelected(b){if('function'!=typeof b)throw new Error('callback is not a function !');this.callbackUser=b}},{key:'insertModal',value:function insertModal(){0===$('#modal_docga').length&&$('body').append('\n          <div id="modal_docga" class="docga_modal">\n              <div class="docga_modal-content">\n                  <div class="docga_modal-head">\n                      <span class="docga_title">DocGA</span>\n                      <span class="docga_close">&times;</span>\n                  </div>\n                  <div class="docga_modal-body">\n                      <div class="docga_directories-tree">\n                          <div class="docga_directories-title">R\xE9pertoires</div>\n                      </div>\n                      <div class="docga_diver"></div>\n                      <div class="docga_documents">\n                          <div class="docga_ariane_directories"></div>\n                      </div>\n                  </div>\n                  <div class="docga_modal-footer">\n                      <div id="docga_valid_selection">Valider la s\xE9lection</div>\n                  </div>\n               </div>\n          </div>\n        ')}}]),a}(),md5=function(a){var b=M(V(Y(X(a),8*a.length)));return b.toLowerCase()};function M(a){for(var b,c='0123456789ABCDEF',j='',l=0;l<a.length;l++)b=a.charCodeAt(l),j+=c.charAt(15&b>>>4)+c.charAt(15&b);return j}function X(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(c=0;c<8*a.length;c+=8)b[c>>5]|=(255&a.charCodeAt(c/8))<<c%32;return b}function V(a){for(var b='',c=0;c<32*a.length;c+=8)b+=String.fromCharCode(255&a[c>>5]>>>c%32);return b}function Y(a,b){a[b>>5]|=128<<b%32,a[14+(b+64>>>9<<4)]=b;for(var c=1732584193,j=-271733879,l=-1732584194,o=271733878,p=0;p<a.length;p+=16){var q=c,s=j,u=l,v=o;j=md5_ii(j=md5_ii(j=md5_ii(j=md5_ii(j=md5_hh(j=md5_hh(j=md5_hh(j=md5_hh(j=md5_gg(j=md5_gg(j=md5_gg(j=md5_gg(j=md5_ff(j=md5_ff(j=md5_ff(j=md5_ff(j,l=md5_ff(l,o=md5_ff(o,c=md5_ff(c,j,l,o,a[p+0],7,-680876936),j,l,a[p+1],12,-389564586),c,j,a[p+2],17,606105819),o,c,a[p+3],22,-1044525330),l=md5_ff(l,o=md5_ff(o,c=md5_ff(c,j,l,o,a[p+4],7,-176418897),j,l,a[p+5],12,1200080426),c,j,a[p+6],17,-1473231341),o,c,a[p+7],22,-45705983),l=md5_ff(l,o=md5_ff(o,c=md5_ff(c,j,l,o,a[p+8],7,1770035416),j,l,a[p+9],12,-1958414417),c,j,a[p+10],17,-42063),o,c,a[p+11],22,-1990404162),l=md5_ff(l,o=md5_ff(o,c=md5_ff(c,j,l,o,a[p+12],7,1804603682),j,l,a[p+13],12,-40341101),c,j,a[p+14],17,-1502002290),o,c,a[p+15],22,1236535329),l=md5_gg(l,o=md5_gg(o,c=md5_gg(c,j,l,o,a[p+1],5,-165796510),j,l,a[p+6],9,-1069501632),c,j,a[p+11],14,643717713),o,c,a[p+0],20,-373897302),l=md5_gg(l,o=md5_gg(o,c=md5_gg(c,j,l,o,a[p+5],5,-701558691),j,l,a[p+10],9,38016083),c,j,a[p+15],14,-660478335),o,c,a[p+4],20,-405537848),l=md5_gg(l,o=md5_gg(o,c=md5_gg(c,j,l,o,a[p+9],5,568446438),j,l,a[p+14],9,-1019803690),c,j,a[p+3],14,-187363961),o,c,a[p+8],20,1163531501),l=md5_gg(l,o=md5_gg(o,c=md5_gg(c,j,l,o,a[p+13],5,-1444681467),j,l,a[p+2],9,-51403784),c,j,a[p+7],14,1735328473),o,c,a[p+12],20,-1926607734),l=md5_hh(l,o=md5_hh(o,c=md5_hh(c,j,l,o,a[p+5],4,-378558),j,l,a[p+8],11,-2022574463),c,j,a[p+11],16,1839030562),o,c,a[p+14],23,-35309556),l=md5_hh(l,o=md5_hh(o,c=md5_hh(c,j,l,o,a[p+1],4,-1530992060),j,l,a[p+4],11,1272893353),c,j,a[p+7],16,-155497632),o,c,a[p+10],23,-1094730640),l=md5_hh(l,o=md5_hh(o,c=md5_hh(c,j,l,o,a[p+13],4,681279174),j,l,a[p+0],11,-358537222),c,j,a[p+3],16,-722521979),o,c,a[p+6],23,76029189),l=md5_hh(l,o=md5_hh(o,c=md5_hh(c,j,l,o,a[p+9],4,-640364487),j,l,a[p+12],11,-421815835),c,j,a[p+15],16,530742520),o,c,a[p+2],23,-995338651),l=md5_ii(l,o=md5_ii(o,c=md5_ii(c,j,l,o,a[p+0],6,-198630844),j,l,a[p+7],10,1126891415),c,j,a[p+14],15,-1416354905),o,c,a[p+5],21,-57434055),l=md5_ii(l,o=md5_ii(o,c=md5_ii(c,j,l,o,a[p+12],6,1700485571),j,l,a[p+3],10,-1894986606),c,j,a[p+10],15,-1051523),o,c,a[p+1],21,-2054922799),l=md5_ii(l,o=md5_ii(o,c=md5_ii(c,j,l,o,a[p+8],6,1873313359),j,l,a[p+15],10,-30611744),c,j,a[p+6],15,-1560198380),o,c,a[p+13],21,1309151649),l=md5_ii(l,o=md5_ii(o,c=md5_ii(c,j,l,o,a[p+4],6,-145523070),j,l,a[p+11],10,-1120210379),c,j,a[p+2],15,718787259),o,c,a[p+9],21,-343485551),c=safe_add(c,q),j=safe_add(j,s),l=safe_add(l,u),o=safe_add(o,v)}return[c,j,l,o]}function md5_cmn(a,b,c,j,l,o){return safe_add(bit_rol(safe_add(safe_add(b,a),safe_add(j,o)),l),c)}function md5_ff(a,b,c,j,l,o,p){return md5_cmn(b&c|~b&j,a,b,l,o,p)}function md5_gg(a,b,c,j,l,o,p){return md5_cmn(b&j|c&~j,a,b,l,o,p)}function md5_hh(a,b,c,j,l,o,p){return md5_cmn(b^c^j,a,b,l,o,p)}function md5_ii(a,b,c,j,l,o,p){return md5_cmn(c^(b|~j),a,b,l,o,p)}function safe_add(a,b){var c=(65535&a)+(65535&b);return(a>>16)+(b>>16)+(c>>16)<<16|65535&c}function bit_rol(a,b){return a<<b|a>>>32-b}
